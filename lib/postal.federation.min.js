/*!
 *  * postal.federation - A base plugin for federating instances of postal.js across various boundaries.
 *  * Author: Jim Cowart (http://ifandelse.com)
 *  * Version: v0.5.5
 *  * Url: http://github.com/postaljs/postal.federation
 *  * License(s): (MIT OR GPL-2.0)
 */
(function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("lodash"),require("postal")):"function"==typeof define&&define.amd?define(["lodash","postal"],t):"object"==typeof exports?exports.postalFedx=t(require("lodash"),require("postal")):e.postalFedx=t(e._,e.postal)})(this,function(e,t){return function(e){function t(i){if(n[i])return n[i].exports;var a=n[i]={exports:{},id:i,loaded:!1};return e[i].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){function i(e){return e&&e.__esModule?e:{"default":e}}function a(e){y.signalReady.apply(this,e)}function o(e){y.send.apply(this,e)}function s(e){y.onFederatedMsg.call(this,e)}Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),c=i(r),u=n(2),d=i(u);n(3);var l=n(4),f=n(5),p=n(6),g=n(7),h=i(g),k=n(8),_=i(k),y=d["default"].fedx={FederationClient:_["default"],packingSlips:l.packingSlips,handlers:p.handlers,clients:f.state._clients,transports:f.state._transports,filters:h["default"],addFilter:g.addFilter,removeFilter:g.removeFilter,canSendRemote:function(e,t){return(0,g.matchesFilter)(e,t,"out")},configure:f.configure,getPackingSlip:l.getPackingSlip,onFederatedMsg:p.onFederatedMsg,sendMessage:function(e){return f.state._ready?void c["default"].forEach(this.transports,function(t){t.sendMessage(e)}):void f.state._outboundQueue.push(arguments)},disconnect:f.disconnect,_getTransports:function(){return c["default"].reduce(this.transports,function(e,t,n){return e[n]=!0,e},{})},signalReady:function(e,t,n){if(!f.state._ready)return void f.state._signalQueue.push(arguments);var i=this._getTransports();switch(arguments.length){case 1:"function"==typeof e?n=e:"string"==typeof e&&(i={},i[e]=this.transports[e],n=f.NO_OP);break;case 2:"string"==typeof e?(i={},i[e]=this.transports[e]):i=e,n=t||f.NO_OP;break;case 3:i={},i[e]=[t]}c["default"].forEach(i,c["default"].bind(function(e,t){e="boolean"==typeof e?[]:e,this.transports[t].signalReady(e,n)},this))}};t["default"]=y,d["default"].addWireTap(function(e,t){y.canSendRemote(t.channel,t.topic)&&y.sendMessage(t)}),d["default"].subscribe({channel:d["default"].configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",callback:function(){for(f.state._ready=!0;f.state._signalQueue.length;)a(f.state._signalQueue.shift());for(;f.state._outboundQueue.length;)o(f.state._outboundQueue.shift());for(;f.state._inboundQueue.length;)s(f.state._inboundQueue.shift())}}),void 0!==d["default"].instanceId()&&(f.state._ready=!0),e.exports=t["default"]},function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t,n){function i(e){return e&&e.__esModule?e:{"default":e}}var a=n(2),o=i(a);o["default"].createUUID||(o["default"].createUUID=function(){for(var e=[],t="0123456789abcdef",n=0;n<36;n++)e[n]=t.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")}),o["default"].instanceId||(o["default"].instanceId=function(){var e=void 0,t=void 0;return function(n){return n&&(t=e,e=n,o["default"].publish({channel:o["default"].configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",data:{oldId:t,newId:e}})),e}}())},function(e,t,n){function i(e){return e&&e.__esModule?e:{"default":e}}function a(e){if(Object.prototype.hasOwnProperty.call(r,e))return r[e].apply(this,Array.prototype.slice.call(arguments,1))}Object.defineProperty(t,"__esModule",{value:!0}),t.getPackingSlip=a;var o=n(2),s=i(o),r={ping:function(){return{type:"federation.ping",instanceId:s["default"].instanceId(),timeStamp:new Date,ticket:s["default"].createUUID()}},pong:function(e){return{type:"federation.pong",instanceId:s["default"].instanceId(),timeStamp:new Date,pingData:{instanceId:e.instanceId,timeStamp:e.timeStamp,ticket:e.ticket}}},message:function(e){return{type:"federation.message",instanceId:s["default"].instanceId(),timeStamp:new Date,envelope:e}},disconnect:function(){return{type:"federation.disconnect",instanceId:s["default"].instanceId(),timeStamp:new Date}},bundle:function(e){return{type:"federation.bundle",instanceId:s["default"].instanceId(),timeStamp:new Date,packingSlips:e}}};t.packingSlips=r},function(e,t,n){function i(e){return e&&e.__esModule?e:{"default":e}}function a(e){if(e&&e.filterMode&&"blacklist"!==e.filterMode&&"whitelist"!==e.filterMode)throw new Error("postal.fedx filterMode must be 'blacklist' or 'whitelist'.");return e&&(d._config=r["default"].defaults(e,c)),d._config}function o(e){e=e||{};var t=d._transports;e.transport&&(t={},t[e.transport]=d._transports[e.transport]),r["default"].forEach(t,function(t){t.disconnect({target:e.target,instanceId:e.instanceId,doNotNotify:!!e.doNotNotify})})}Object.defineProperty(t,"__esModule",{value:!0}),t.configure=a,t.disconnect=o;var s=n(1),r=i(s),c={enabled:!0,filterMode:"whitelist",filterDirection:"both"},u=function(){};t.NO_OP=u;var d={_clients:[],_transports:{},_ready:!1,_inboundQueue:[],_outboundQueue:[],_signalQueue:[],_config:c};t.state=d},function(e,t,n){function i(e){return e&&e.__esModule?e:{"default":e}}function a(e){if(!s.state._ready)return void s.state._inboundQueue.push(e);if(!Object.prototype.hasOwnProperty.call(f,e.packingSlip.type))throw new Error("postal.federation does not have a message handler for '"+e.packingSlip.type+"'.");f[e.packingSlip.type](e)}Object.defineProperty(t,"__esModule",{value:!0}),t.onFederatedMsg=a;var o=n(4),s=n(5),r=n(7),c=n(2),u=i(c),d=n(1),l=i(d),f={"federation.ping":function(e){e.source.setInstanceId(e.packingSlip.instanceId),e.source.handshakeComplete?e.source.sendPong(e.packingSlip):e.source.sendBundle([(0,o.getPackingSlip)("pong",e.packingSlip),(0,o.getPackingSlip)("ping")])},"federation.pong":function(e){e.source.handshakeComplete=!0,e.source.setInstanceId(e.packingSlip.instanceId),e.source.pings[e.packingSlip.pingData.ticket]&&(e.source.pings[e.packingSlip.pingData.ticket].callback({ticket:e.packingSlip.pingData.ticket,instanceId:e.packingSlip.instanceId,source:e.source}),e.source.pings[e.packingSlip.pingData.ticket]=void 0),l["default"].includes(s.state._clients,e.packingSlip.instanceId)||s.state._clients.push(e.packingSlip.instanceId),u["default"].publish({channel:"postal.federation",topic:"client.federated",data:{remoteId:e.source.instanceId,localId:u["default"].instanceId(),transport:e.transport}})},"federation.disconnect":function(e){s.state._clients=l["default"].without(s.state._clients,e.source.instanceId),(0,s.disconnect)({transport:e.source.transportName,instanceId:e.source.instanceId,doNotNotify:!0})},"federation.message":function(e){var t=e.packingSlip.envelope;(0,r.matchesFilter)(t.channel,t.topic,"in")&&(t.lastSender=e.packingSlip.instanceId,u["default"].publish(t))},"federation.bundle":function(e){l["default"].forEach(e.packingSlip.packingSlips,function(t){a(l["default"].extend({},e,{packingSlip:t}))})}};t.handlers=f},function(e,t,n){function i(e){return e&&e.__esModule?e:{"default":e}}function a(e){e=c["default"].isArray(e)?e:[e],c["default"].forEach(e,function(e){e.direction=e.direction||u.state._config.filterDirection,c["default"].forEach("both"===e.direction?["in","out"]:[e.direction],function(t){f[t][e.channel]?c["default"].includes(f[t][e.channel],e.topic)||f[t][e.channel].push(e.topic):f[t][e.channel]=[e.topic]})})}function o(e){e=c["default"].isArray(e)?e:[e],c["default"].forEach(e,function(e){e.direction=e.direction||u.state._config.filterDirection,c["default"].forEach("both"===e.direction?["in","out"]:[e.direction],function(t){f[t][e.channel]&&c["default"].includes(f[t][e.channel],e.topic)&&(f[t][e.channel]=c["default"].without(f[t][e.channel],e.topic))})})}function s(e,t,n){var i=Object.prototype.hasOwnProperty.call(f[n],e),a=i&&c["default"].some(f[n][e],function(e){return l["default"].configuration.resolver.compare(e,t)}),o="blacklist"===u.state._config.filterMode;return u.state._config.enabled&&(o&&(!i||i&&!a)||!o&&i&&a)}Object.defineProperty(t,"__esModule",{value:!0}),t.addFilter=a,t.removeFilter=o,t.matchesFilter=s;var r=n(1),c=i(r),u=n(5),d=n(2),l=i(d),f={"in":{},out:{}};t["default"]=f},function(e,t,n){function i(e){return e&&e.__esModule?e:{"default":e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s=n(4),r=n(6),c=n(5),u=n(2),d=i(u),l=n(1),f=i(l),p=function(){function e(t,n,i){a(this,e),this.target=t,this.options=n||{},this.pings={},this.instanceId=i,this.handshakeComplete=!1}return o(e,[{key:"sendPing",value:function(e){var t=(0,s.getPackingSlip)("ping");this.pings[t.ticket]={ticket:t.ticket,callback:e||c.NO_OP},this.send(t)}},{key:"sendPong",value:function(e){this.send((0,s.getPackingSlip)("pong",e))}},{key:"sendBundle",value:function(e){this.send((0,s.getPackingSlip)("bundle",e))}},{key:"sendMessage",value:function(e){if(this.handshakeComplete){e.originId=e.originId||d["default"].instanceId();var t=f["default"].clone(e);!this.instanceId||this.instanceId===t.lastSender||t.knownIds&&t.knownIds.length&&(!t.knownIds||f["default"].includes(t.knownIds,this.instanceId))||(t.knownIds=(t.knownIds||[]).concat(f["default"].without(c.state._clients,this.instanceId)),this.send((0,s.getPackingSlip)("message",t)))}}},{key:"disconnect",value:function(){this.send((0,s.getPackingSlip)("disconnect"))}},{key:"onMessage",value:function(e){this.shouldProcess()&&(0,r.onFederatedMsg)({transport:this.transportName,packingSlip:e,source:this})}},{key:"shouldProcess",value:function(){return!0}},{key:"send",value:function(){throw new Error("An object deriving from FederationClient must provide an implementation for 'send'.")}},{key:"setInstanceId",value:function(e){this.instanceId=e}}],[{key:"extend",value:function(t,n){function i(){e.apply(this,arguments)}return i.prototype=Object.create(e.prototype),f["default"].extend(i.prototype,t),f["default"].extend(i,n),i}}]),e}();t["default"]=p,e.exports=t["default"]}])});
//# sourceMappingURL=postal.federation.min.js.map
